h1. Installing Trisul on Security Onion

"Security Onion":http://securityonion.blogspot.com/ is a Linux Distro which makes it dead easy to deploy a full fledged Network Security Monitoring system. This document describes how you can install Trisul on this distro.

<div class="callout callout-danger">
<h6><i class="fa fa-area-chart"></i> Why Trisul Network Analytics?</h6>
 Trisul adds network traffic charts and flow analytics to your Security Onion based NSM.
</div>

<ul class="step-text">

<li>

h2. Install Trisul 

* Follow the instructions for *Ubuntu 16.04* on the "Download":/download page and install Trisul packages on your Security Onion box. 
* Update the shared library cache <pre class="language-bash">sudo ldconfig</pre>
* Open up *Port 3000 and 3003* required for the Trisul web interface  <pre class="language-bash">sudo ufw allow 3000 
sudo ufw allow 3003</pre>
* At this point you have a fully functional Trisul installation. You can test this by logging on to @<ip>:3000@ as admin/admin. Step 2 through 5 integrate Trisul with the alerts generated by Snort/Suricata. 
* Automatically start trisul-probe on startup 
<pre class="language-bash">update-rc.d trisul-probe0-context0 defaults </pre>

</li>

<li>

h2. Change user to sguil from trisul

By default all Trisul processes and data are owner by the user @trisul@ You need to change the user to @sguil@ so it integrates better with the rest of the Security Onion processes. In particular, Trisul needs to read the Barnyard2 Unix Socket that is owned by @sguil@. 


<ul>
<li>

h3. Change the hub and probe permissions to sguil 

Run @sudo trisulctl_hub@  then on the CLI enter the following.  Type  @quit@ to exit the domain management tool "trisulctl_hub CLI":/docs/ug/domain/trisulctl.html

<pre class="language-bash">
sudo trisulctl_hub
changeuser domain domain0 sguil.sguil
</pre>

again for the included Trisul-Probe

<pre class="language-bash">
sudo trisulctl_probe
changeuser domain domain0 sguil.sguil
</pre>

</li>


<li>

h3. Restart web server

Restart the webserver under new ownership of @sguil@

<pre class="language-bash">
sudo service webtrisuld restart
</pre>

</li>


</ul>

</li>

<li>

h2. Adjust the config file

Almost there. You need to make a couple of changes to the "config file":/docs/ref/trisulconfig.html to connect to IDS alerts from barnyard2. 

* Open the config file  in @/usr/local/etc/trisul-probe/domain0/probe0/context0/trisulProbeConfig.xml@
* Change the @<IDSAlerts><UnixSocket>@ parameter to @/nsm/sensor_data/xx-yy-eth0/barnyard2_alert@ Replace the directory name _xx-yy-eth0_ with what you see on your machine. Type @ls /nsm/sensor_data@ to find out what that is.  
* NEW: If you want to listen to multiple sockets, now you can. Just add as many @<UnixSocket>@ sections as you want. See example below for two sockets.
<pre class='language-xml'><code>
<UnixSocket>
    /nsm/sensor_data/unpl-seco-16-prod-enp1s0/barnyard2_alert
</UnixSocket>
<UnixSocket>
    /nsm/sensor_data/unpl-seco-16-prod-enp2s0/barnyard2_alert
</UnixSocket>
</code>
</pre>

</li>

<li>

h2. Configure and restart Barnyard

<ul>
<li>
Open the barnyard2 configuration file  in @/etc/nsm/xx-yy-eth0/barnyard2-1.conf@ and add the following line at the end of configuration file.	

<pre class='language-bash'>
output alert_unixsock
</pre>
If you are listening on more than one unix socket, change all the @barnyard2-1.conf@ files to enable the @output alert_unixsock@ option

</li>
<li>
Restart barnyard. 

<pre class="language-bash">
sudo nsm_sensor_ps-restart --only-barnyard2
</pre>

</li>
</ul>

<li>

h2. Start Trisul from the web interface

Go to @ip:3000@ then login as admin/admin
Then Go to Context : default > Admin Tasks > Start/Stop Tasks and restart the Hub and Probe(s) 

p(autohint hand-o-right info). 
 *Default eth0* By default Trisul listens on eth0, if you wish to change it read "Change capture adapter":/docs/ug/webadmin/profiles.html

</li>

</ul>

*Congratulations !* You have finished installing Trisul. 

Login as user/user and check if you see the various dashboards. Check if you are seeing alerts on the real time alert stabber _Dashboard > Real Time Alerts_ 

</li>

</ul>

<div class="faq">

h2. More things to do  



<ul>

<li>

h6. How to move the Trisul database to /nsm ?

<div>
Trisul stores its data under  @/usr/local/var@, Security Onion likes to store it in @/nsm@. 

You will need to use the Domain management CLI tools @trisulctl_probe@ and @trisulctl_hub@ commands to move the database to the @/nsm@ volume.

h5. Move probe DB

<pre class="language-bash">
trisulctl_probe
relocate context domain0 probe0 default 
</pre>

h5. Move hub DB

<pre class="language-bash">
trisulctl_hub
relocate context domain0 hub0 default 
</pre>

For more see "Relocate database":/docs/ug/basicusage/reloc.html  or type @help relocate@ in the domain management CLI tool.
</div>
</li>

<li>

h6. How to switch to NETFLOW mode

<div>

You can choose to use Trisul on the Security Onion box to monitor Netflow. Follow the instructions in "Configure Netflow":/docs/ug/netflow/netflow_setup.html to start consuming Netflow (and SFLOW/IPFIX/JFLOW etc). 

You can even do the following once you are comfortable with one instance of Trisul.

# Use the default context for PCAP based monitoring
# Spin up a second, new context say @nf1@ for monitoring Netflow

h5. New context for netflow

<pre class="language-bash">
trisulctl_hub
create context nf1 
</pre>

Then follow instructions in "Configure Netflow":/docs/ug/netflow/netflow_setup.html on the nf1 context.


</div>
</li>

<li>

h6. How to automatically start the Trisul Probe on reboot

<div>
By default, the Web Server and the Trisul Hub components start automatically after a reboot. To automatically start the Probe processes use the normal init.d framework. 

<pre class="language-bash">
update-rc.d trisul-probe0-context0 defaults 
</pre>

</div>
</li>


<li>

h6. How to add a new remote Probe 

<div>
Trisul can also be deployed in a distributed hub and probe configuration.  See instructions for "How to add a new Probe":/docs/ug/domain/deploy_probe.html
</div>
</li>


<li>

h6. How to change network interfaces amd web server ports

<div>

 * Listen on an interface other than eth0   ["Docs":/docs/ug/webadmin/profiles.html]
 * Move Web server ports from 3000 and 3003 ["Docs":/docs/howto/change_web_port.html]
 * Enable SSL for the web interface ["Docs":/docs/howto/sslforwebtr.html]

</div>
</li>



<li>

h6. How to stop and start Trisul processes 

<div>

If you want to stop all Trisul processes on a Security Onion system 

<pre class="language-bash">
trisulctl_hub stop context default
trisulctl_hub stop domain
trisulctl_probe stop domain
service webtrisuld stop
</pre>

to start - its the reverse order. 

<pre class="language-bash">
trisulctl_hub start domain
trisulctl_probe start domain
trisulctl_hub start context default
service webtrisuld start
</pre>

</div>
</li>

<li>

h6. Are there any other useful plugins? 

<div>

You may want to install the following plugins from the "Download Page":/download/index.html

# "URL Filter":/docs/ug/install/urlfilter.html
# "BadFellas":/docs/ug/install/badfellas.html
# "Geo":/docs/ug/install/geoasn.html

Also checkout the NEW Trisul Apps. Login as admin and select "Web Admin>Apps"


</div>
</li>

</ul>